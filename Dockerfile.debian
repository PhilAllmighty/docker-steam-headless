FROM debian:trixie-slim
LABEL maintainer="Josh.5 <jsunnex@gmail.com>"

# Update package repos
ARG DEBIAN_FRONTEND=noninteractive
RUN \
    echo "**** Update apt database ****" \
        && sed -i '/^Components: main/ s/$/ contrib non-free/' /etc/apt/sources.list.d/debian.sources \
    && \
    echo

# Update locale
RUN \
    echo "**** Update apt database ****" \
        && apt-get update \
    && \
    echo "**** Install and configure locals ****" \
        && apt-get install -y --no-install-recommends \
            locales \
        && echo 'en_US.UTF-8 UTF-8' > /etc/locale.gen \
        && echo 'en_GB.UTF-8 UTF-8' >> /etc/locale.gen \
        && locale-gen \
    && \
    echo "**** Section cleanup ****" \
        && apt-get clean autoclean -y \
        && apt-get autoremove -y \
        && rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/* \
    && \
    echo
ENV \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8

# Re-install certificates
RUN \
    echo "**** Update apt database ****" \
        && apt-get update \
    && \
    echo "**** Install certificates ****" \
        && apt-get install -y --reinstall \
            ca-certificates \
    && \
    echo "**** Section cleanup ****" \
        && apt-get clean autoclean -y \
        && apt-get autoremove -y \
        && rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/* \
    && \
    echo

# Install core packages
RUN \
    echo "**** Update apt database ****" \
        && apt-get update \
    && \
    echo "**** Install tools ****" \
        && apt-get install -y --no-install-recommends \
            bash bash-completion curl git jq less man-db plocate nano \
            net-tools p7zip-full patch pciutils pkg-config procps psmisc \
            psutils rsync screen sudo unzip vim wget xmlstarlet xz-utils \
    && \
    echo "**** Install python ****" \
        && apt-get install -y --no-install-recommends \
            python3 python3-numpy python3-pip python3-setuptools python3-venv \
    && \
    echo "**** Section cleanup ****" \
        && apt-get clean autoclean -y \
        && apt-get autoremove -y \
        && rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/* \
    && \
    echo

# Configure default user
ENV \
    PUID=99 \
    PGID=100 \
    UMASK=000 \
    USER="default" \
    USER_PASSWORD="password" \
    USER_HOME="/home/default" \
    TZ="Pacific/Auckland" \
    USER_LOCALES="en_US.UTF-8 UTF-8"
RUN \
    mkdir -p ${USER_HOME} \
    && useradd -d ${USER_HOME} -s /bin/bash ${USER} \
    && chown -R ${USER} ${USER_HOME} \
    && echo "${USER} ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# Install supervisor
RUN \
    apt-get update \
    && apt-get install -y supervisor \
    && apt-get clean autoclean -y \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/*

# X Server
ENV \
    XORG_SOCKET_DIR="/tmp/.X11-unix" \
    XDG_RUNTIME_DIR="/tmp/.X11-unix/run" \
    XDG_SESSION_TYPE="x11" \
    FORCE_X11_DUMMY_CONFIG="false"
RUN \
    apt-get update \
    && apt-get install -y --no-install-recommends \
        avahi-utils dbus-x11 libxcomposite-dev libxcursor1 wmctrl libfuse2 \
        x11-utils x11-xfs-utils x11-xkb-utils x11-xserver-utils x11vnc \
        xauth xbindkeys xclip xcvt xdotool xfonts-base xinit xorg \
        xserver-xorg-core xserver-xorg-input-evdev \
        xserver-xorg-input-libinput xserver-xorg-legacy \
        xserver-xorg-video-all xserver-xorg-video-dummy \
    && apt-get clean autoclean -y \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/*

# Audio
ENV \
    PULSE_SOCKET_DIR="/tmp/pulse" \
    PULSE_SERVER="unix:/tmp/pulse/pulse-socket"
RUN \
    apt-get update \
    && apt-get install -y --no-install-recommends \
        pulseaudio alsa-utils libasound2 libasound2-plugins \
    && apt-get clean autoclean -y \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/*

# Desktop
RUN \
    apt-get update \
    && apt-get install -y --no-install-recommends \
        libdbus-1-3 libegl1 libgtk-3-0 libgtk2.0-0 libsdl2-2.0-0 \
    && apt-get install -y \
        fonts-vlgothic gedit imagemagick msttcorefonts xdg-utils \
        xfce4 xfce4-terminal \
    && apt-get clean autoclean -y \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/*

# Flatpak + D-Bus
ENV \
    XDG_DATA_DIRS="/home/default/.local/share/flatpak/exports/share:/var/lib/flatpak/exports/share:/usr/local/share/:/usr/share/"
RUN \
    apt-get update \
    && apt-get install -y --no-install-recommends \
        accountsservice polkitd pkexec flatpak gnome-software-plugin-flatpak \
    && flatpak remote-add flathub https://flathub.org/repo/flathub.flatpakrepo \
    && dpkg-statoverride --update --add root root 0755 /usr/bin/bwrap \
    && apt-get clean autoclean -y \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/*

# -------------------------------
# Intel Battlemage (Xe2) Graphics
# -------------------------------
RUN \
    apt-get update \
    && apt-get install -y --no-install-recommends \
        mesa-utils \
        mesa-va-drivers \
        mesa-vulkan-drivers \
        libegl-mesa0 \
        libgl1-mesa-dri \
        libglx-mesa0 \
        libdrm2 \
        libdrm-intel1 \
        intel-media-va-driver-non-free \
        va-driver-all \
        vulkan-tools \
    && apt-get clean autoclean -y \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/*

ENV \
    MESA_LOADER_DRIVER_OVERRIDE=iris \
    LIBVA_DRIVER_NAME=iHD \
    VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/intel_icd.x86_64.json

# Monitoring tools
RUN \
    apt-get update \
    && apt-get install -y --no-install-recommends \
        cpu-x htop vainfo vdpauinfo \
    && apt-get clean autoclean -y \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/*

# Steam
RUN \
    dpkg --add-architecture i386 \
    && apt-get update \
    && apt-get install -y --no-install-recommends steam-installer \
    && ln -sf /usr/games/steam /usr/bin/steam \
    && apt-get clean autoclean -y \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/*

# Sunshine
RUN \
    apt-get update \
    && apt-get install -y va-driver-all \
    && SUNSHINE_URL=$(curl -s https://api.github.com/repos/LizardByte/Sunshine/releases/latest \
        | jq -r '.assets[] | select(.name | contains("trixie-amd64.deb")) | .browser_download_url') \
    && wget -O /usr/src/sunshine.deb "$SUNSHINE_URL" \
    && apt-get install -y /usr/src/sunshine.deb \
    && apt-get clean autoclean -y \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/* /var/tmp/* /tmp/*

# Neko
COPY --from=m1k1o/neko:base /usr/bin/neko /usr/bin/neko
COPY --from=m1k1o/neko:base /var/www /var/www

# dumb-init + dumb-udev
ARG DUMB_INIT_VERSION=1.2.5
ARG DUMB_UDEV_VERSION=64d1427
RUN \
    wget -qO /usr/bin/dumb-init \
        https://github.com/Yelp/dumb-init/releases/download/v${DUMB_INIT_VERSION}/dumb-init_${DUMB_INIT_VERSION}_x86_64 \
    && chmod +x /usr/bin/dumb-init \
    && python3 -m pip install --break-system-packages --no-cache-dir \
        git+https://github.com/Steam-Headless/dumb-udev.git@${DUMB_UDEV_VERSION}

# Overlay
COPY overlay /

# Display
ENV \
    DISPLAY_CDEPTH="24" \
    DISPLAY_REFRESH="120" \
    DISPLAY_SIZEH="900" \
    DISPLAY_SIZEW="1600" \
    DISPLAY_VIDEO_PORT="DFP" \
    DISPLAY=":55"

ENV \
    NVIDIA_DRIVER_CAPABILITIES="all" \
    NVIDIA_VISIBLE_DEVICES="all"

# Container config
ENV \
    MODE="primary" \
    WEB_UI_MODE="vnc" \
    ENABLE_VNC_AUDIO="true" \
    NEKO_PASSWORD=neko \
    NEKO_PASSWORD_ADMIN=admin \
    ENABLE_STEAM="true" \
    STEAM_ARGS="-silent" \
    WEBUI_USER="" \
    WEBUI_PASS="" \
    ENABLE_SUNSHINE="true" \
    ENABLE_EVDEV_INPUTS="true" \
    ENABLE_WOL_POWER_MANAGER="false" \
    ENABLE_SID="false"

ENV \
    PORT_NOVNC_WEB="8083" \
    NEKO_NAT1TO1=""

EXPOSE 8083

RUN chmod +x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]
