FROM debian:trixie-slim
LABEL maintainer="Josh.5 <jsunnex@gmail.com>"

ARG DEBIAN_FRONTEND=noninteractive

# Enable contrib & non-free
RUN \
    sed -i '/^Components: main/ s/$/ contrib non-free non-free-firmware/' /etc/apt/sources.list.d/debian.sources

# Locale
RUN \
    apt-get update && \
    apt-get install -y --no-install-recommends locales && \
    echo 'en_US.UTF-8 UTF-8' > /etc/locale.gen && \
    echo 'en_GB.UTF-8 UTF-8' >> /etc/locale.gen && \
    locale-gen && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

ENV \
    LANG=en_US.UTF-8 \
    LANGUAGE=en_US:en \
    LC_ALL=en_US.UTF-8

# Certificates
RUN \
    apt-get update && \
    apt-get install -y --reinstall ca-certificates && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Core tools
RUN \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        bash bash-completion curl git jq less man-db plocate nano \
        net-tools p7zip-full patch pciutils pkg-config procps psmisc \
        psutils rsync screen sudo unzip vim wget xmlstarlet xz-utils \
        python3 python3-numpy python3-pip python3-setuptools python3-venv && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# User
ENV \
    USER=default \
    USER_HOME=/home/default \
    TZ=Pacific/Auckland

RUN \
    useradd -m -d ${USER_HOME} -s /bin/bash ${USER} && \
    echo "${USER} ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# Supervisor
RUN \
    apt-get update && \
    apt-get install -y supervisor && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# X11
ENV \
    XDG_RUNTIME_DIR="/tmp/.X11-unix/run" \
    XDG_SESSION_TYPE=x11

RUN \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        dbus-x11 wmctrl libfuse2 x11-utils x11-xserver-utils \
        x11vnc xauth xclip xdotool xfonts-base xinit xorg \
        xserver-xorg-core xserver-xorg-video-all \
        xserver-xorg-video-dummy && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Audio
ENV \
    PULSE_SOCKET_DIR="/tmp/pulse" \
    PULSE_SERVER="unix:/tmp/pulse/pulse-socket"

RUN \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        pulseaudio alsa-utils libasound2 libasound2-plugins && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Desktop
RUN \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        libdbus-1-3 libegl1 libgtk-3-0 libsdl2-2.0-0 \
        xfce4 xfce4-terminal gedit fonts-vlgothic imagemagick \
        msttcorefonts xdg-utils && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Flatpak
ENV \
    XDG_DATA_DIRS="/home/default/.local/share/flatpak/exports/share:/var/lib/flatpak/exports/share:/usr/share"

RUN \
    apt-get update && \
    apt-get install -y flatpak gnome-software-plugin-flatpak && \
    flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Web frontend + Node
ARG NODE_VERSION=v20
RUN \
    wget -qO- https://nodejs.org/dist/latest-${NODE_VERSION}.x/node-*-linux-x64.tar.xz | \
    tar -xJ --strip-components=1 -C /usr/local

RUN \
    git clone https://github.com/Steam-Headless/frontend.git /opt/frontend && \
    rm -rf /opt/frontend/.git

# Websockify
RUN \
    pip3 install --break-system-packages websockify

# GStreamer + streaming deps
RUN \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        gstreamer1.0-* libopenal1 libsndfile1 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Intel VAAPI
RUN \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        intel-media-va-driver-non-free \
        i965-va-driver-shaders \
        libva2 libva-drm2 libva-x11-2 \
        libdrm2 mesa-va-drivers mesa-vulkan-drivers \
        vainfo && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Steam
RUN \
    dpkg --add-architecture i386 && \
    apt-get update && \
    apt-get install -y steam-installer && \
    ln -sf /usr/games/steam /usr/bin/steam && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Sunshine
RUN \
    apt-get update && \
    apt-get install -y va-driver-all && \
    SUNSHINE_URL=$(curl -s https://api.github.com/repos/LizardByte/Sunshine/releases/latest | \
        jq -r '.assets[] | select(.name|contains("debian-trixie-amd64.deb")).browser_download_url') && \
    wget -O /tmp/sunshine.deb "$SUNSHINE_URL" && \
    apt-get install -y /tmp/sunshine.deb && \
    rm -f /tmp/sunshine.deb && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Intel VAAPI auto-detect (OLD + NEW)
ENV \
    LIBVA_DRIVERS_PATH=/usr/lib/x86_64-linux-gnu/dri \
    VAAPI_DEVICE=/dev/dri/renderD128 \
    SUNSHINE_ENCODER=vaapi

# Neko
COPY --from=m1k1o/neko:base /usr/bin/neko /usr/bin/neko
COPY --from=m1k1o/neko:base /var/www /var/www

# Init
RUN \
    wget -O /usr/bin/dumb-init https://github.com/Yelp/dumb-init/releases/download/v1.2.5/dumb-init_1.2.5_x86_64 && \
    chmod +x /usr/bin/dumb-init

# Overlay + entrypoint
COPY overlay /
RUN chmod +x /entrypoint.sh

ENV \
    DISPLAY=:55 \
    ENABLE_SUNSHINE=true \
    ENABLE_STEAM=true

EXPOSE 8083
ENTRYPOINT ["/entrypoint.sh"]
